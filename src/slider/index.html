<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" >
    <title>Круглые числа. (или «Зачем программисту логарифм»)</title>
</head>
<body>
    <div>

        <h1>Круглые числа.<br/><small>(или «Зачем программисту логарифм»)</small></h1>

        <img src="achtung.jpg" style="float:right;width:250px;margin-left:10px;margin-bottom:10px" />

        <p>Начнем с постановки практической задачи: Необходимо организовать удобный интерфейс для ввода диапазона числовых значений.<br />
        На практике это может потребоваться при создании «фильтров» для товарных каталогов: подвергаться фильтрации могут такие характеристики, как «<a href="http://market.yandex.ru/guru.xml?CMD=-RR=9,0,0,0-VIS=160-CAT_ID=108206-EXF=1-EXC=1-PG=10&hid=90639">диагональ телевизора</a>», «<a href="http://market.yandex.ru/guru.xml?CMD=-RR=9,0,0,0-VIS=160-CAT_ID=107500-EXF=1-EXC=1-PG=10&hid=90594">минимальная температура в морозильной камере холодильника</a>», «<a href="http://market.yandex.ru/guru.xml?CMD=-RR=9,0,0,0-VIS=160-CAT_ID=432460-EXF=1-EXC=1-PG=10&hid=91013">частота процессора</a>».<br />
        В самом общем случае это могут быть положительные и отрицательные, целые и дробные числа, покрывающие некоторое недискретное пространство значений.</p>

        <p>Очевидное и самое простое в реализации решение:</p>
        <fieldset id="example1">
            <label>от: <input type="text" size="4" /></label>
            <label>до: <input type="text" size="4" /></label>
        </fieldset>
        <p>Такой интерфейс обладает рядом недостатков, среди которых выделим три наиболее важных:</p>
        <ul>
            <li>пользователь вынужден обращаться к клавиатуре</li>
            <li>пользователь может ошибиться при вводе (например, дробных значений)</li>
            <li>пользователь не информирован о диапазоне чисел, имеющих смысл в контексте фильтра</li>
        </ul>

        <p>Все эти недостатки легко устраняются применением инструмента «слайдер» из состава большого количества современных javascript фреймворков. Мы для примера возьмем один из наиболее популярных: <a href="http://jqueryui.com/demos/slider/#range">jQuery UI Slider</a>.</p>
        <p>Воспользовавшись примером из документации, получаем легкое и удобное решение:</p>

        <div id="example2"></div>
        <p>Отсюда и далее все примеры будем приводить на базе этих трех характеристик: целочисленной, целочисленной отрицательной и дробной</p>

        <p>Хорошо. Все три недостатка мы устранили. Но можно лучше. Избавим пользователя от необходимости «прицеливаться» ползунком, оглядываясь на значение числового индикатора. Для этого нанесем шкалу значений:</p>
        <div id="example3"></div>

        <p>Ещё лучше. Но что-то в этих числах явно не так — это не те числа, которыми привык пользоваться человек. Это не круглые числа! На их месте так и просится что-то вроде: «500, 800, 1100, 1400, …», «-24, -22, -20, -18, …»</p>

        <p>Википедия нам <a href="http://ru.wikipedia.org/wiki/%D0%9A%D1%80%D1%83%D0%B3%D0%BB%D1%8B%D0%B5_%D1%87%D0%B8%D1%81%D0%BB%D0%B0">говорит</a> о двух близких, по сути, трактовках термина «Круглые числа»: «10, 100, 1000, …» и «10, 20, 30, …». В общем виде круглое число в десятичной системе счисления имеет вид ±N×10<sup>k</sup>, где N — десятичная цифра, а k любое <a href="http://ru.wikipedia.org/wiki/%D0%9D%D0%B0%D1%82%D1%83%D1%80%D0%B0%D0%BB%D1%8C%D0%BD%D0%BE%D0%B5_%D1%87%D0%B8%D1%81%D0%BB%D0%BE">натуральное число</a>. Для нашей задачи мы вынуждены будем расширить понятие круглого числа множеством чисел с отрицательными k (0.1, 0.2, …, 0.007, …), т.к. исчислять коэффициент аэродинамического сопротивления целыми числами не представляется возможным.</p>
        <p>Итак, для построения «правильной» шкалы нам потребуется научиться вычислять такие минимальное и максимальное значения, а также величину шага, чтобы каждая метка на шкале была круглым числом.</p>
        <p>Очевидно, что в этом случае наша шкала станет немного шире или уже, т.к. граничные значения сместятся в круглые позиции. Сужать — недопустимо: мы не можем позволить себе «выкинуть товар» из поиска. Следовательно, левую границу будем округлять до меньшего, правую границу и шаг — до большего круглого числа.<br />
        Важно также понимать, что для нашей задачи, при вычислении минимального значения, говорить о ближайшем круглом для, например, 517, — в отрыве от всего диапазона не имеет смысла. На его роль могло бы пойти число 500, будь у нас интервал от 517 до 3000 или, например, 510, будь у нас интервал от 517 до 550.</p>


        <p>Верным решением задачи будем считать такой набор значений минимального (MIN<sub>o</sub>), максимального числа (MAX<sub>o</sub>) и величины шага (STEP<sub>o</sub>), который удовлетворяет условиям:</p>
        <blockquote><code>
            MIN<sub>o</sub> ≤ MIN <span class="comment">// новый минимум не больше исходного</span><br />
            MAX<sub>o</sub> ≥ MAX <span class="comment">// новый максимум не меньше исходного</span><br />
            STEP<sub>o</sub> × N = MAX<sub>o</sub> - MIN<sub>o</sub><br />
        </code></blockquote>

        <p>Поиск круглого шага сводится к поиску ближайшего большего или равного круглого числа. Для этого исходный шаг необходимо разложить в <a href="http://ru.wikipedia.org/wiki/%D0%AD%D0%BA%D1%81%D0%BF%D0%BE%D0%BD%D0%B5%D0%BD%D1%86%D0%B8%D0%B0%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F_%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D1%8C">экспоненциальную запись</a>:</p>
        <blockquote><code>
            STEP = (MAX-MIN) / N<br />
            STEP_EXP = floor( log<sub>10</sub>(STEP) )<br />
            STEP_POWER = 10<sup>STEP_EXP</sup><br />
            STEP_MANTISSA = STEP / STEP_POWER<br />
            <span class="comment">// STEP = STEP_MANTISSA * 10<sup>STEP_EXP</sup></span><br />
        </code></blockquote>

        <p>Затем округлить мантиссу до меньшего целого и увеличить на 1</p>

        <blockquote><code>
            STEP<sub>o</sub> = (floor(STEP_MANTISSA) + 1) * STEP_POWER<br />
        </code></blockquote>

        <p>Минимальное значение получим, округлив исходное значение до ближайшего меньшего числа, кратного STEP_POWER. Максимально значение вычислим из минимального и шага</p>

        <blockquote><code>
            MIN<sub>o</sub> = floor(MIN / STEP_POWER) * STEP_POWER<br />
            MAX<sub>o</sub> = MIN<sub>o</sub> + STEP<sub>o</sub> × N<br />
        </code></blockquote>

        <p>Левая граница и величина шага будут соответствовать условиям задачи по способу их получения. А вот правая граница нуждается в дополнительной проверке, так как в общем случае она может оказаться меньше исходного максимума.</p>

        <blockquote><code>
            STEP = (MAX-MIN) / N<br />

            VALID = false;  <span class="comment">// флаг «верное решение найдено»</span><br />
            while not VALID<br />
            begin<br />
            &nbsp;&nbsp;&nbsp;&nbsp;STEP_EXP = floor( log<sub>10</sub>(STEP) )<br />
            &nbsp;&nbsp;&nbsp;&nbsp;STEP_POWER = 10<sup>STEP_EXP</sup><br />
            &nbsp;&nbsp;&nbsp;&nbsp;STEP_MANTISSA = STEP / STEP_POWER<br />

            &nbsp;&nbsp;&nbsp;&nbsp;STEP<sub>o</sub> = (floor(STEP_MANTISSA) + 1) * STEP_POWER<br />
            <br />
            &nbsp;&nbsp;&nbsp;&nbsp;MIN<sub>o</sub> = floor(MIN / STEP_POWER) * STEP_POWER<br />
            &nbsp;&nbsp;&nbsp;&nbsp;MAX<sub>o</sub> = MIN<sub>o</sub> + STEP<sub>o</sub> × N<br />
            <br />
            &nbsp;&nbsp;&nbsp;&nbsp;VALID = MAX<sub>o</sub> ≥ MAX<br />
            <br />
            &nbsp;&nbsp;&nbsp;&nbsp;STEP = STEP<sub>o</sub><span class="comment">// для перехода  следующему круглому числу на следующей итерации цикла</span><br />
            end<br />

        </code></blockquote>



        <p>Применяя этот алгоритм, получаем:</p>
        <div id="example5"></div>

        <p>Такой интерфейс уже можно назвать <a href="http://en.wikipedia.org/wiki/User_Friendly">user friendly</a>, но в нём возник новый недостаток, не свойственный предыдущим примерам: при некоторых значениях MIN, MAX и количества засечек может возникать ситуация, когда интервалы между несколькими последними засечками выходят за пределы [MIN: MAX].<br />
        Примером такой ситуации может служить попытка отобразить диапазон значений [0 : 110] на шкале с десятью интервалами (11 засечек): шаг по 10 не покроет весь диапазон, а шаг по 20 сделает пустыми правые интервалы.
        Простого решения этой проблемы нет, однако, есть способ существенно снизить вероятность появления таких отрезков за счет расширения понятия круглого числа.</p>
        <p>В текущем решении круглыми являются только те числа, <a href="http://ru.wikipedia.org/wiki/%D0%AD%D0%BA%D1%81%D0%BF%D0%BE%D0%BD%D0%B5%D0%BD%D1%86%D0%B8%D0%B0%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F_%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D1%8C">мантисса</a> которых входит в множество натуральных чисел от 1 до 9. Т.е. круглыми считаются только числа: </p>
        <table>
            <tr>
                <td>1</td>
                <td>2</td>
                <td>3</td>
                <td>4</td>
                <td>5</td>
                <td>6</td>
                <td>7</td>
                <td>8</td>
                <td>9</td>
            </tr>
            <tr>
                <td>10</td>
                <td>20</td>
                <td>30</td>
                <td>40</td>
                <td>50</td>
                <td>60</td>
                <td>70</td>
                <td>80</td>
                <td>90</td>
            </tr>
            <tr>
                <td>100</td>
                <td>200</td>
                <td>300</td>
                <td>400</td>
                <td>500</td>
                <td>600</td>
                <td>700</td>
                <td>800</td>
                <td>900</td>
            </tr>
            <tr>
                <td>…</td>
                <td>…</td>
                <td>…</td>
                <td>…</td>
                <td>…</td>
                <td>…</td>
                <td>…</td>
                <td>…</td>
                <td>…</td>
            </tr>
        </table>

        <p>А что, если расширить это множество числами, с мантиссой 1.2, 1.5 и 2.5? В тех самых случаях «пустого» отрезка мы получим более короткие значения (например, округлив 135, вместо 200 — получим 150)</p>

        <table>
            <tr>
                <td>1</td>
                <td>1.2</td>
                <td>1.5</td>
                <td>2</td>
                <td>2.5</td>
                <td>3</td>
                <td>4</td>
                <td>5</td>
                <td>6</td>
                <td>7</td>
                <td>8</td>
                <td>9</td>
            </tr>
            <tr>
                <td>10</td>
                <td>12</td>
                <td>15</td>
                <td>20</td>
                <td>25</td>
                <td>30</td>
                <td>40</td>
                <td>50</td>
                <td>60</td>
                <td>70</td>
                <td>80</td>
                <td>90</td>
            </tr>
            <tr>
                <td>100</td>
                <td>120</td>
                <td>150</td>
                <td>200</td>
                <td>250</td>
                <td>300</td>
                <td>400</td>
                <td>500</td>
                <td>600</td>
                <td>700</td>
                <td>800</td>
                <td>900</td>
            </tr>
            <tr>
                <td>…</td>
                <td>…</td>
                <td>…</td>
                <td>…</td>
                <td>…</td>
                <td>…</td>
                <td>…</td>
                <td>…</td>
                <td>…</td>
                <td>…</td>
                <td>…</td>
                <td>…</td>
            </tr>
        </table>

        <p>Описывать алгоритм поиска ближайшего круглого по «новым правилам» не буду, полагая, что это не будет сложной задачей.
        Сразу покажу результат такого апгрейда:</p>

        <div id="example6"></div>

        <h2>Итог</h2>
        <p>Я мог бы сам подвести итог под всем сказанным выше, но думаю, что своим глазам читатель верит больше, поэтому — сводный пример:</p>

        <div id="example-summary"></div>

        <h2>Details</h2>
        <p><strong>Математика</strong></p>
        <p>Помимо привычной десятичной системы счисления, существуют и другие. Им не в меньшей степени свойственно понятие круглого числа. И, хотя это имеет малое практическое значение, всё сказанное действительно и для них. (0xF000 воспринимается проще, чем 0xA48C, да? :-) )</p>
        <p><strong>Язык программирования</strong></p>
        <p>Если в вашем языке программирования нет функции вычисления десятичного логарифма, но есть натуральный, как в javascript — не беда: на помощь придут <a href="http://ru.wikipedia.org/wiki/%D0%9B%D0%BE%D0%B3%D0%B0%D1%80%D0%B8%D1%84%D0%BC#.D0.A1.D0.B2.D0.BE.D0.B9.D1.81.D1.82.D0.B2.D0.B0">свойства логарифмов</a>.</p>
        <blockquote><code>
            log<sub>N</sub>(x) = ln(x) / ln(N)<br />
            log<sub>10</sub>(x) = ln(x) / ln(10)<br />
        </code></blockquote>
        <p><strong>Исходный код</strong></p>
        <p>Алгоритмы, описанные в этой статье, и код, иллюстрирующий применение алгоритмов в связке с jQuery UI Slider, вы можете найти реализованными на языке javascript в прилагаемой к статье <a href="https://github.com/autowp/pereslegin.ru/blob/master/src/slider/index.js">библиотеке</a>.</p>



        <h2>Future</h2>
        <p>Как говорится: совершенству нет предела. Интерфейс выбора диапазона значений всё ещё можно совершенствовать:</p>
        <ul>
            <li>В некоторых случаях может быть полезна экспоненциальная шкала. Не теряя наглядности, она позволит детализировать отдельные, значимые, насыщенные участки отрезка и, наоборот, сузить разреженные. Очевидный пример: товарный каталог с эксклюзивными позициями. Цены в таком каталоге будет сосредоточены чуть ниже среднего значения, тогда как верхние отрезки окажутся почти пустыми.</li>
            <li>Для некоторых физических величин обратный порядок следования значений. Температура в морозильной камере — должна начинаться с минимального по модулю значения.</li>
        </ul>
        <p>Есть над чем поработать!</p>

        <p>P.S. Показались наши примеры неудачными? Попробуйте свои значения:</p>
        <fieldset id="examples-values">

        </fieldset>

        <h2>Ссылки:</h2>
        <p>
            <a href="http://jqueryui.com/">jQuery UI</a>,
            <a href="http://ru.wikipedia.org/wiki/%D0%AD%D0%BA%D1%81%D0%BF%D0%BE%D0%BD%D0%B5%D0%BD%D1%86%D0%B8%D0%B0%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F_%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D1%8C">Экспоненциальная запись</a>,
            <a href="http://ru.wikipedia.org/wiki/%D0%9D%D0%B0%D1%82%D1%83%D1%80%D0%B0%D0%BB%D1%8C%D0%BD%D0%BE%D0%B5_%D1%87%D0%B8%D1%81%D0%BB%D0%BE">Натуральное число</a>,
            <a href="http://ru.wikipedia.org/wiki/%D0%9B%D0%BE%D0%B3%D0%B0%D1%80%D0%B8%D1%84%D0%BC">Логарифм</a>,
            <a href="http://ru.wikipedia.org/wiki/%D0%9A%D1%80%D1%83%D0%B3%D0%BB%D1%8B%D0%B5_%D1%87%D0%B8%D1%81%D0%BB%D0%B0">Круглые числа</a>,
            <a href="http://en.wikipedia.org/wiki/Floor_and_ceiling_functions">Floor and ceiling functions</a>
        </p>

    </div>
</body>
</html>